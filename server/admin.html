<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration</title>
    
    <!-- Favicon et ic√¥nes pour raccourcis mobile -->
    <link rel="icon" type="image/png" href="/api/logo">
    <link rel="apple-touch-icon" href="/api/logo">
    <meta name="theme-color" content="#00e1ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Admin">
    
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #000;
        color: #00e1ff;
        min-height: 100vh;
      }
      
      /* ========== HEADER ========== */
      .admin-header {
        background: #111;
        padding: 10px;
        text-align: center;
        border-bottom: 2px solid #00e1ff;
      }
      .admin-header img {
        max-height: 60px;
        width: auto;
      }
      
      /* ========== ONGLETS ========== */
      .tabs-container {
        display: flex;
        background: #111;
        border-bottom: 1px solid #333;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .tab-btn {
        flex: 1;
        min-width: 80px;
        padding: 15px 8px;
        background: transparent;
        border: none;
        color: #666;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
      }
      .tab-btn.active {
        color: #00e1ff;
        background: rgba(0, 225, 255, 0.1);
        border-bottom: 3px solid #00e1ff;
      }
      .tab-btn:hover {
        background: rgba(0, 225, 255, 0.05);
      }
      
      /* ========== CONTENU ========== */
      .tab-content {
        display: none;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      }
      .tab-content.active {
        display: block;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      /* ========== FORMULAIRES ========== */
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
      }
      input, select, textarea {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        color: #00e1ff;
        background: #222;
        border: 1px solid #00e1ff;
        border-radius: 4px;
      }
      input[type="color"] {
        height: 50px;
        padding: 5px;
        cursor: pointer;
      }
      input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
      }
      textarea {
        min-height: 80px;
        resize: vertical;
      }
      button {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        font-weight: bold;
        color: #000;
        background: #00e1ff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
      }
      button:hover {
        background: #00b8d4;
      }
      button.danger {
        background: #ff3333;
        color: white;
      }
      button.secondary {
        background: #444;
        color: #00e1ff;
      }
      
      /* ========== SECTIONS ========== */
      .section {
        background: #111;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .section h3 {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #333;
      }
      
      /* ========== MESSAGES DYNAMIQUES ========== */
      .day-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 15px;
      }
      .day-tab {
        flex: 1;
        min-width: 60px;
        padding: 10px 5px;
        background: #222;
        border: 1px solid #333;
        color: #666;
        font-size: 12px;
        cursor: pointer;
        text-align: center;
        border-radius: 4px;
      }
      .day-tab.active {
        background: #00e1ff;
        color: #000;
        border-color: #00e1ff;
      }
      .day-content {
        display: none;
      }
      .day-content.active {
        display: block;
      }
      
      /* ========== R√àGLES COULEURS ========== */
      .color-rule {
        background: #222;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      }
      .color-rule-row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .color-rule-row input[type="text"] {
        flex: 1;
        min-width: 100px;
      }
      .color-rule-row input[type="color"] {
        width: 60px;
        flex-shrink: 0;
      }
      .color-rule-row button {
        width: auto;
        padding: 10px 15px;
        margin: 0;
      }
      
      /* ========== LOGO ========== */
      .logo-preview {
        max-width: 200px;
        max-height: 100px;
        margin-top: 15px;
        border: 1px solid #333;
        border-radius: 4px;
      }
      
      /* ========== R√âSULTATS ========== */
      .result-message {
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        text-align: center;
      }
      .result-message.success {
        background: rgba(0, 255, 0, 0.1);
        color: #00ff00;
      }
      .result-message.error {
        background: rgba(255, 0, 0, 0.1);
        color: #ff3333;
      }
      
      /* ========== LISTE √âV√âNEMENTS ADMIN ========== */
      .events-list {
        max-height: 300px;
        overflow-y: auto;
      }
      .admin-event {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #222;
        border: 1px solid #333;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .admin-event:hover {
        background: #2a2a2a;
        border-color: #00e1ff;
      }
      .admin-event.completed {
        opacity: 0.5;
        text-decoration: line-through;
        background: #1a1a1a;
      }
      .admin-event .check {
        font-size: 1.3em;
        flex-shrink: 0;
      }
      .admin-event .time {
        color: #00e1ff;
        font-weight: bold;
        min-width: 60px;
      }
      .admin-event .title {
        flex: 1;
      }
      .admin-event .location {
        color: #888;
        font-size: 0.9em;
      }
      .no-events {
        color: #666;
        font-style: italic;
        padding: 15px;
        text-align: center;
      }
      
      /* ========== RESPONSIVE ========== */
      @media (min-width: 768px) {
        .tabs-container {
          justify-content: center;
          overflow-x: hidden; /* Pas de scrollbar sur PC */
        }
        .tab-btn {
          flex: 1;
          max-width: 140px;
          min-width: auto;
        }
        .tab-content {
          max-width: 800px;
          margin: 0 auto;
        }
        .day-tabs {
          flex-wrap: nowrap;
        }
      }
    </style>
</head>
<body>
    <header class="admin-header">
        <img src="/api/logo" alt="Logo" id="headerLogo">
    </header>

    <!-- Navigation par onglets -->
    <nav class="tabs-container">
        <button class="tab-btn active" data-tab="events">üìã √âv√©nements</button>
        <button class="tab-btn" data-tab="config">üé® Apparence</button>
        <button class="tab-btn" data-tab="messages">üí¨ Messages</button>
        <button class="tab-btn" data-tab="colors">üè∑Ô∏è Couleurs</button>
        <button class="tab-btn" data-tab="logo">üñºÔ∏è Logo</button>
        <button class="tab-btn" data-tab="sync">üîÑ Sync</button>
    </nav>

    <!-- ==================== ONGLET √âV√âNEMENTS ==================== -->
    <div class="tab-content active" id="tab-events">
        <div class="section">
            <h3>üìã √âv√©nements du jour</h3>
            <p style="color:#888; font-size:14px;">Cliquez sur un √©v√©nement pour le marquer comme termin√©.</p>
            
            <h4 style="margin-top:20px;">üóìÔ∏è √âv√©nements ponctuels</h4>
            <div id="adminRegularEvents" class="events-list"></div>
            
            <h4 style="margin-top:20px;">üîÑ √âv√©nements r√©currents</h4>
            <div id="adminRecurrentEvents" class="events-list"></div>
            
            <button onclick="loadAdminEvents()" style="margin-top:20px;">üîÑ Rafra√Æchir</button>
            <div id="eventsResult" class="result-message" style="display:none;"></div>
        </div>
    </div>

    <!-- ==================== ONGLET CONFIG ==================== -->
    <div class="tab-content" id="tab-config">
        <div class="section">
            <h3>üé® Configuration de l'apparence</h3>
            <form id="configForm">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="showWeatherToggle">
                        Afficher la m√©t√©o
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="scrollToggle" checked>
                        D√©filement automatique des √©v√©nements
                    </label>
                </div>
                <div class="form-group">
                    <label>Couleur principale</label>
                    <input type="color" id="primaryColor" value="#00e1ff">
                </div>
                <div class="form-group">
                    <label>Couleur secondaire</label>
                    <input type="color" id="secondaryColor" value="#000000">
                </div>
                <div class="form-group">
                    <label>Couleur fond √©v√©nements</label>
                    <input type="color" id="eventBgColor" value="#000000">
                </div>
                <div class="form-group">
                    <label>Couleur texte √©v√©nements</label>
                    <input type="color" id="eventTextColor" value="#ffffff">
                </div>
                <div class="form-group">
                    <label>Police</label>
                    <select id="fontFamily">
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                        <option value="Tahoma, sans-serif">Tahoma</option>
                        <option value="Georgia, serif">Georgia</option>
                    </select>
                </div>
                <button type="submit">üíæ Enregistrer</button>
            </form>
            <div id="configResult" class="result-message" style="display:none;"></div>
        </div>
    </div>

    <!-- ==================== ONGLET MESSAGES ==================== -->
    <div class="tab-content" id="tab-messages">
        <div class="section">
            <h3>üí¨ Messages d'accueil dynamiques</h3>
            <p style="color:#888; font-size:14px;">Configurez les messages affich√©s selon le jour et le cr√©neau horaire.</p>
            
            <!-- Sous-onglets par jour -->
            <div class="day-tabs">
                <button class="day-tab active" data-day="lundi">Lun</button>
                <button class="day-tab" data-day="mardi">Mar</button>
                <button class="day-tab" data-day="mercredi">Mer</button>
                <button class="day-tab" data-day="jeudi">Jeu</button>
                <button class="day-tab" data-day="vendredi">Ven</button>
            </div>
            
            <form id="welcomeMessagesForm">
                <div id="messagesContainer"></div>
                <button type="submit">üíæ Enregistrer les messages</button>
            </form>
            <div id="messagesResult" class="result-message" style="display:none;"></div>
        </div>
    </div>

    <!-- ==================== ONGLET COULEURS ==================== -->
    <div class="tab-content" id="tab-colors">
        <div class="section">
            <h3>üè∑Ô∏è R√®gles de couleurs</h3>
            <p style="color:#888; font-size:14px;">D√©finissez les couleurs d'affichage des √©v√©nements selon les mots-cl√©s.</p>
            
            <div id="colorRulesContainer"></div>
            
            <button class="secondary" onclick="addColorRule()">‚ûï Ajouter une r√®gle</button>
            <button onclick="saveColorRules()">üíæ Enregistrer les r√®gles</button>
            <div id="colorRulesResult" class="result-message" style="display:none;"></div>
        </div>
    </div>

    <!-- ==================== ONGLET LOGO ==================== -->
    <div class="tab-content" id="tab-logo">
        <div class="section">
            <h3>üñºÔ∏è Logo de l'entreprise</h3>
            <form id="logoForm">
                <div class="form-group">
                    <label>S√©lectionner une image</label>
                    <input type="file" id="logoInput" accept="image/*">
                </div>
                <button type="submit">üì§ Uploader le logo</button>
            </form>
            <div id="logoResult" class="result-message" style="display:none;"></div>
            <p style="margin-top:20px; color:#888;">Logo actuel :</p>
            <img id="logoPreview" class="logo-preview" src="/api/logo" alt="Logo actuel">
        </div>
    </div>

    <!-- ==================== ONGLET SYNC ==================== -->
    <div class="tab-content" id="tab-sync">
        <div class="section">
            <h3>üîÑ Synchronisation</h3>
            <p style="color:#888; font-size:14px;">Forcez une synchronisation imm√©diate du calendrier Google.</p>
            <button onclick="forceSync()">üîÑ Synchroniser maintenant</button>
            <div id="syncResult" class="result-message" style="display:none;"></div>
        </div>
    </div>

    <script>
      const backendUrl = location.origin;
      const days = ["lundi", "mardi", "mercredi", "jeudi", "vendredi"];
      const slots = [
        { id: "matin", label: "Matin (06h-09h30)" },
        { id: "matinee", label: "Matin√©e (09h30-12h)" },
        { id: "midi", label: "Midi (12h-13h)" },
        { id: "apres_midi", label: "Apr√®s-midi (13h-18h)" },
        { id: "soir", label: "Soir (18h-06h)" }
      ];
      let colorRulesData = [];
      let welcomeMessagesData = {};

      // ========== NAVIGATION ONGLETS ==========
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
      });

      // ========== NAVIGATION JOURS ==========
      document.querySelectorAll('.day-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.day-tab').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.day-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('day-' + btn.dataset.day).classList.add('active');
        });
      });

      // ========== CONFIGURATION ==========
      async function loadConfig() {
        const res = await fetch(`${backendUrl}/api/config`);
        const config = await res.json();
        document.getElementById('primaryColor').value = config.primaryColor || '#00e1ff';
        document.getElementById('secondaryColor').value = config.secondaryColor || '#000000';
        document.getElementById('fontFamily').value = config.fontFamily || 'Arial, sans-serif';
        document.getElementById('eventBgColor').value = config.eventBgColor || '#000000';
        document.getElementById('eventTextColor').value = config.eventTextColor || '#ffffff';
        document.getElementById('showWeatherToggle').checked = config.showWeather || false;
      }

      document.getElementById('configForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
          primaryColor: document.getElementById('primaryColor').value,
          secondaryColor: document.getElementById('secondaryColor').value,
          fontFamily: document.getElementById('fontFamily').value,
          eventBgColor: document.getElementById('eventBgColor').value,
          eventTextColor: document.getElementById('eventTextColor').value,
          showWeather: document.getElementById('showWeatherToggle').checked
        };
        await fetch(`${backendUrl}/api/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        showResult('configResult', 'Configuration enregistr√©e !', true);
      });

      // ========== MESSAGES DYNAMIQUES ==========
      async function loadWelcomeMessages() {
        const res = await fetch(`${backendUrl}/api/welcome-messages`);
        const data = await res.json();
        welcomeMessagesData = data.welcomeMessages || {};
        renderMessagesForm();
      }

      function renderMessagesForm() {
        const container = document.getElementById('messagesContainer');
        container.innerHTML = '';
        
        days.forEach(day => {
          const dayDiv = document.createElement('div');
          dayDiv.className = 'day-content' + (day === 'lundi' ? ' active' : '');
          dayDiv.id = 'day-' + day;
          
          let html = '';
          slots.forEach(slot => {
            const val = welcomeMessagesData?.[day]?.[slot.id] || '';
            html += `
              <div class="form-group">
                <label>${slot.label}</label>
                <textarea id="${day}_${slot.id}" placeholder="Message pour ${slot.label.toLowerCase()}...">${val}</textarea>
              </div>
            `;
          });
          dayDiv.innerHTML = html;
          container.appendChild(dayDiv);
        });
      }

      document.getElementById('welcomeMessagesForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const messages = {};
        days.forEach(day => {
          messages[day] = {};
          slots.forEach(slot => {
            messages[day][slot.id] = document.getElementById(`${day}_${slot.id}`).value;
          });
        });
        
        const res = await fetch(`${backendUrl}/api/welcome-messages`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ welcomeMessages: messages })
        });
        showResult('messagesResult', res.ok ? 'Messages enregistr√©s !' : 'Erreur', res.ok);
      });

      // ========== R√àGLES COULEURS ==========
      async function loadColorRules() {
        try {
          const res = await fetch(`${backendUrl}/api/event-color-rules`);
          const data = await res.json();
          colorRulesData = data.rules || [];
        } catch (err) {
          colorRulesData = [];
        }
        renderColorRules();
      }

      function renderColorRules() {
        const container = document.getElementById('colorRulesContainer');
        container.innerHTML = '';
        
        colorRulesData.forEach((rule, index) => {
          container.innerHTML += `
            <div class="color-rule">
              <div class="color-rule-row">
                <input type="text" placeholder="Mot-cl√©" value="${rule.keyword || ''}" 
                       onchange="colorRulesData[${index}].keyword = this.value">
                <input type="color" value="${rule.color || '#ffffff'}" 
                       onchange="colorRulesData[${index}].color = this.value">
                <button class="danger" onclick="removeRule(${index})" style="width:auto;">üóëÔ∏è</button>
              </div>
              <input type="text" placeholder="Description (optionnel)" value="${rule.description || ''}" 
                     onchange="colorRulesData[${index}].description = this.value" style="margin-top:10px;">
            </div>
          `;
        });
      }

      function addColorRule() {
        colorRulesData.push({ keyword: '', color: '#00e1ff', description: '' });
        renderColorRules();
      }

      function removeRule(index) {
        colorRulesData.splice(index, 1);
        renderColorRules();
      }

      async function saveColorRules() {
        const res = await fetch(`${backendUrl}/api/event-color-rules`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rules: colorRulesData })
        });
        showResult('colorRulesResult', res.ok ? 'R√®gles enregistr√©es !' : 'Erreur', res.ok);
      }

      // ========== LOGO ==========
      document.getElementById('logoForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = document.getElementById('logoInput').files[0];
        if (!file) {
          showResult('logoResult', 'Veuillez s√©lectionner un fichier', false);
          return;
        }
        const formData = new FormData();
        formData.append('logo', file);
        const res = await fetch(`${backendUrl}/api/logo`, {
          method: 'POST',
          body: formData
        });
        if (res.ok) {
          document.getElementById('logoPreview').src = '/api/logo?' + Date.now();
          showResult('logoResult', 'Logo mis √† jour !', true);
        } else {
          showResult('logoResult', 'Erreur lors de l\'upload', false);
        }
      });

      // ========== SYNCHRONISATION ==========
      async function forceSync() {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '‚è≥ Synchronisation...';
        
        try {
          const res = await fetch(`${backendUrl}/api/sync`, { method: 'POST' });
          const data = await res.json();
          showResult('syncResult', res.ok ? 'Synchronisation r√©ussie !' : 'Erreur: ' + data.error, res.ok);
        } catch (err) {
          showResult('syncResult', 'Erreur de connexion', false);
        }
        
        btn.disabled = false;
        btn.textContent = 'üîÑ Synchroniser maintenant';
      }

      // ========== GESTION DES √âV√âNEMENTS ==========
      let adminCompletedEvents = [];
      
      async function loadAdminEvents() {
        try {
          // Charger les √©v√©nements
          const eventsRes = await fetch(`${backendUrl}/api/events`);
          const eventsData = await eventsRes.json();
          
          // Charger les √©v√©nements termin√©s
          const completedRes = await fetch(`${backendUrl}/api/completed-events`);
          const completedData = await completedRes.json();
          adminCompletedEvents = completedData.completed || [];
          
          // Afficher les √©v√©nements r√©guliers
          const regularContainer = document.getElementById('adminRegularEvents');
          const regularEvents = eventsData.regular || [];
          
          if (regularEvents.length === 0) {
            regularContainer.innerHTML = '<div class="no-events">Aucun √©v√©nement ponctuel aujourd\'hui</div>';
          } else {
            regularContainer.innerHTML = regularEvents.map(e => renderAdminEvent(e)).join('');
          }
          
          // Afficher les √©v√©nements r√©currents
          const recurrentContainer = document.getElementById('adminRecurrentEvents');
          const recurrentEvents = eventsData.recurrent || [];
          
          if (recurrentEvents.length === 0) {
            recurrentContainer.innerHTML = '<div class="no-events">Aucun √©v√©nement r√©current aujourd\'hui</div>';
          } else {
            recurrentContainer.innerHTML = recurrentEvents.map(e => renderAdminEvent(e)).join('');
          }
          
        } catch (err) {
          console.error('Erreur chargement √©v√©nements:', err);
          showResult('eventsResult', 'Erreur de chargement', false);
        }
      }
      
      function renderAdminEvent(event) {
        const eventId = String(event.id || `${event.title || event.summary}_${event.start}`);
        const isCompleted = adminCompletedEvents.includes(eventId);
        const startTime = new Date(event.start);
        const timeStr = startTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        const title = event.title || event.summary || 'Sans titre';
        const location = event.location || '';
        
        return `
          <div class="admin-event ${isCompleted ? 'completed' : ''}" 
               onclick="toggleAdminEvent('${eventId}', this)"
               data-event-id="${eventId}">
            <span class="check">${isCompleted ? '‚úÖ' : '‚¨ú'}</span>
            <span class="time">${timeStr}</span>
            <span class="title">${title}</span>
            ${location ? `<span class="location">üìç ${location}</span>` : ''}
          </div>
        `;
      }
      
      async function toggleAdminEvent(eventId, element) {
        const strEventId = String(eventId);
        const isCompleted = adminCompletedEvents.includes(strEventId);
        const endpoint = isCompleted ? '/api/uncomplete-event' : '/api/complete-event';
        
        try {
          const res = await fetch(`${backendUrl}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ eventId: strEventId })
          });
          
          if (res.ok) {
            if (isCompleted) {
              adminCompletedEvents = adminCompletedEvents.filter(id => id !== strEventId);
              element.classList.remove('completed');
              element.querySelector('.check').textContent = '‚¨ú';
            } else {
              adminCompletedEvents.push(strEventId);
              element.classList.add('completed');
              element.querySelector('.check').textContent = '‚úÖ';
            }
            showResult('eventsResult', isCompleted ? '√âv√©nement r√©activ√©' : '√âv√©nement termin√© !', true);
          }
        } catch (err) {
          showResult('eventsResult', 'Erreur lors de la mise √† jour', false);
        }
      }

      // ========== UTILITAIRES ==========
      function showResult(elementId, message, success) {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.className = 'result-message ' + (success ? 'success' : 'error');
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 3000);
      }

      // ========== INITIALISATION ==========
      document.addEventListener('DOMContentLoaded', () => {
        loadAdminEvents(); // Charger les √©v√©nements au d√©marrage
        loadConfig();
        loadWelcomeMessages();
        loadColorRules();
        
        // Scroll toggle
        const scrollToggle = document.getElementById('scrollToggle');
        scrollToggle.checked = localStorage.getItem('scrollEnabled') !== 'false';
        scrollToggle.addEventListener('change', () => {
          localStorage.setItem('scrollEnabled', scrollToggle.checked);
        });
      });
    </script>
</body>
</html>