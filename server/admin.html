<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration</title>
    
    <!-- Favicon et ic√¥nes pour raccourcis mobile -->
    <link rel="icon" type="image/png" href="/api/logo">
    <link rel="apple-touch-icon" href="/api/logo">
    <meta name="theme-color" content="#00e1ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Admin">
    
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #000;
        color: #00e1ff;
        min-height: 100vh;
      }
      
      /* ========== HEADER ========== */
      .admin-header {
        background: #111;
        padding: 10px;
        text-align: center;
        border-bottom: 2px solid #00e1ff;
      }
      .admin-header img {
        max-height: 60px;
        width: auto;
      }
      
      /* ========== ONGLETS ========== */
      .tabs-container {
        display: flex;
        background: #111;
        border-bottom: 1px solid #333;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .tab-btn {
        flex: 1;
        min-width: 80px;
        padding: 15px 8px;
        background: transparent;
        border: none;
        color: #666;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
      }
      .tab-btn.active {
        color: #00e1ff;
        background: rgba(0, 225, 255, 0.1);
        border-bottom: 3px solid #00e1ff;
      }
      .tab-btn:hover {
        background: rgba(0, 225, 255, 0.05);
      }
      
      /* ========== CONTENU ========== */
      .tab-content {
        display: none;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      }
      .tab-content.active {
        display: block;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      /* ========== FORMULAIRES ========== */
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
      }
      input, select, textarea {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        color: #00e1ff;
        background: #222;
        border: 1px solid #00e1ff;
        border-radius: 4px;
      }
      input[type="color"] {
        height: 50px;
        padding: 5px;
        cursor: pointer;
      }
      input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
      }
      textarea {
        min-height: 80px;
        resize: vertical;
      }
      button {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        font-weight: bold;
        color: #000;
        background: #00e1ff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
      }
      button:hover {
        background: #00b8d4;
      }
      button.danger {
        background: #ff3333;
        color: white;
      }
      button.secondary {
        background: #444;
        color: #00e1ff;
      }
      
      /* ========== SECTIONS ========== */
      .section {
        background: #111;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .section h3 {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #333;
      }
      
      /* ========== MESSAGES DYNAMIQUES ========== */
      .day-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 15px;
      }
      .day-tab {
        flex: 1;
        min-width: 60px;
        padding: 10px 5px;
        background: #222;
        border: 1px solid #333;
        color: #666;
        font-size: 12px;
        cursor: pointer;
        text-align: center;
        border-radius: 4px;
      }
      .day-tab.active {
        background: #00e1ff;
        color: #000;
        border-color: #00e1ff;
      }
      .day-content {
        display: none;
      }
      .day-content.active {
        display: block;
      }
      
      /* ========== R√àGLES COULEURS ========== */
      .color-rule {
        background: #222;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      }
      .color-rule-row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .color-rule-row input[type="text"] {
        flex: 1;
        min-width: 100px;
      }
      .color-rule-row input[type="color"] {
        width: 60px;
        flex-shrink: 0;
      }
      .color-rule-row button {
        width: auto;
        padding: 10px 15px;
        margin: 0;
      }
      
      /* ========== LOGO ========== */
      .logo-preview {
        max-width: 200px;
        max-height: 100px;
        margin-top: 15px;
        border: 1px solid #333;
        border-radius: 4px;
      }
      
      /* ========== R√âSULTATS ========== */
      .result-message {
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        text-align: center;
      }
      .result-message.success {
        background: rgba(0, 255, 0, 0.1);
        color: #00ff00;
      }
      .result-message.error {
        background: rgba(255, 0, 0, 0.1);
        color: #ff3333;
      }
      
      /* ========== LISTE √âV√âNEMENTS ADMIN ========== */
      .events-list {
        max-height: 300px;
        overflow-y: auto;
      }
      .admin-event {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #222;
        border: 1px solid #333;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .admin-event:hover {
        background: #2a2a2a;
        border-color: #00e1ff;
      }
      .admin-event.completed {
        opacity: 0.5;
        text-decoration: line-through;
        background: #1a1a1a;
      }
      .admin-event .check {
        font-size: 1.3em;
        flex-shrink: 0;
      }
      .admin-event .time {
        color: #00e1ff;
        font-weight: bold;
        min-width: 60px;
      }
      .admin-event .title {
        flex: 1;
      }
      .admin-event .location {
        color: #888;
        font-size: 0.9em;
      }
      .no-events {
        color: #666;
        font-style: italic;
        padding: 15px;
        text-align: center;
      }
      
      /* ========== RESPONSIVE ========== */
      @media (min-width: 768px) {
        .tabs-container {
          justify-content: center;
          overflow-x: hidden; /* Pas de scrollbar sur PC */
        }
        .tab-btn {
          flex: 1;
          max-width: 140px;
          min-width: auto;
        }
        .tab-content {
          max-width: 800px;
          margin: 0 auto;
        }
        .day-tabs {
          flex-wrap: nowrap;
        }
      }
      
      /* ========== GALERIE GIF ========== */
      .gifs-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      .gif-item {
        position: relative;
        background: #222;
        border: 2px solid #333;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }
      .gif-item:hover {
        border-color: #ff3333;
        background: rgba(255, 51, 51, 0.1);
      }
      .gif-item img {
        max-width: 80px;
        max-height: 80px;
        object-fit: contain;
      }
      .gif-item .gif-name {
        font-size: 10px;
        color: #888;
        margin-top: 5px;
        word-break: break-all;
      }
      .gif-item .delete-overlay {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #ff3333;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }
      .gif-item:hover .delete-overlay {
        display: flex;
      }
      
      /* ========== R√àGLES IC√îNES LIEUX ========== */
      .icon-rule {
        background: #222;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      }
      .icon-rule-row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .icon-rule-row input[type="text"] {
        flex: 1;
        min-width: 120px;
      }
      .icon-rule-row button {
        width: auto;
        padding: 10px 15px;
        margin: 0;
      }
      .icon-selector {
        position: relative;
        cursor: pointer;
      }
      .icon-selector .selected-icon {
        width: 50px;
        height: 50px;
        background: #333;
        border: 2px solid #00e1ff;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      .icon-selector .selected-icon img {
        max-width: 40px;
        max-height: 40px;
        object-fit: contain;
      }
      .icon-selector .selected-icon.empty {
        font-size: 24px;
        color: #666;
      }
      
      /* ========== MOSA√èQUE S√âLECTION IC√îNE ========== */
      .icon-mosaic-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .icon-mosaic-overlay.active {
        display: flex;
      }
      .icon-mosaic-container {
        background: #111;
        border: 2px solid #00e1ff;
        border-radius: 12px;
        padding: 20px;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
      }
      .icon-mosaic-container h3 {
        margin: 0 0 15px 0;
        color: #00e1ff;
        text-align: center;
      }
      .icon-mosaic {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      .icon-mosaic-item {
        background: #222;
        border: 2px solid #333;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .icon-mosaic-item:hover {
        border-color: #00e1ff;
        background: rgba(0, 225, 255, 0.1);
        transform: scale(1.05);
      }
      .icon-mosaic-item img {
        max-width: 50px;
        max-height: 50px;
        object-fit: contain;
      }
      .icon-mosaic-close {
        margin-top: 15px;
        width: 100%;
      }
    </style>
</head>
<body>
    <header class="admin-header">
        <img src="/api/logo" alt="Logo" id="headerLogo">
    </header>

    <!-- Navigation par onglets -->
    <nav class="tabs-container">
        <button class="tab-btn active" data-tab="events">üìã √âv√©nements</button>
        <button class="tab-btn" data-tab="config">üé® Apparence</button>
        <button class="tab-btn" data-tab="messages">üí¨ Messages</button>
        <button class="tab-btn" data-tab="colors">üè∑Ô∏è Couleurs</button>
        <button class="tab-btn" data-tab="icons">üé¨ Ic√¥nes</button>
        <button class="tab-btn" data-tab="logo">üñºÔ∏è Logo</button>
        <button class="tab-btn" data-tab="photo">üì∏ Photo</button>
        <button class="tab-btn" data-tab="sync">üîÑ Sync</button>
    </nav>

    <!-- ==================== ONGLET √âV√âNEMENTS ==================== -->
    <div class="tab-content active" id="tab-events">
        <div class="section">
            <h3>üìã √âv√©nements du jour</h3>
            <p style="color:#888; font-size:14px;">Cliquez sur un √©v√©nement pour le marquer comme termin√©.</p>
            
            <h4 style="margin-top:20px;">üóìÔ∏è √âv√©nements ponctuels</h4>
            <div id="adminRegularEvents" class="events-list"></div>
            
            <h4 style="margin-top:20px;">üîÑ √âv√©nements r√©currents</h4>
            <div id="adminRecurrentEvents" class="events-list"></div>
            
            <button onclick="loadAdminEvents()" style="margin-top:20px;">üîÑ Rafra√Æchir</button>
            <div id="eventsResult" class="result-message" style="display:none;"></div>
        </div>
    </div>

    <!-- ==================== ONGLET CONFIG ==================== -->
    <div class="tab-content" id="tab-config">
        <div class="section">
            <h3>üé® Configuration de l'apparence</h3>
            <form id="configForm">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="showWeatherToggle">
                        Afficher la m√©t√©o
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="scrollToggle" checked>
                        D√©filement automatique des √©v√©nements
                    </label>
                </div>
                <div class="form-group">
                    <label>Couleur principale</label>
                    <input type="color" id="primaryColor" value="#00e1ff">
                </div>
                <div class="form-group">
                    <label>Couleur secondaire</label>
                    <input type="color" id="secondaryColor" value="#000000">
                </div>
                <div class="form-group">
                    <label>Couleur fond √©v√©nements</label>
                    <input type="color" id="eventBgColor" value="#000000">
                </div>
                <div class="form-group">
                    <label>Couleur texte √©v√©nements</label>
                    <input type="color" id="eventTextColor" value="#ffffff">
                </div>
                <div class="form-group">
                    <label>Police</label>
                    <select id="fontFamily">
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                        <option value="Tahoma, sans-serif">Tahoma</option>
                        <option value="Georgia, serif">Georgia</option>
                    </select>
                </div>
                <button type="submit">üíæ Enregistrer</button>
            </form>
            <div id="configResult" class="result-message" style="display:none;"></div>
        </div>
    </div>

    <!-- ==================== ONGLET MESSAGES ==================== -->
    <div class="tab-content" id="tab-messages">
        <!-- Section Message Furtif -->
        <div class="section">
            <h3>‚ö° Message d'accueil furtif</h3>
            <p style="color:#888; font-size:14px;">Activez un message temporaire qui remplace le message d'accueil configur√©.</p>
            
            <form id="sneakyMessageForm">
                <div class="form-group">
                    <label>Message √† afficher</label>
                    <textarea id="sneakyMessageText" placeholder="Entrez votre message furtif..." rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Dur√©e d'affichage</label>
                    <select id="sneakyMessageDuration">
                        <option value="15">15 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="60">1 heure</option>
                        <option value="240">4 heures</option>
                        <option value="endOfDay">Jusqu'√† la fin de la journ√©e</option>
                        <option value="endOfWeek">Jusqu'√† la fin de la semaine</option>
                    </select>
                </div>
                <button type="submit">‚ö° Activer le message furtif</button>
            </form>
            <div id="sneakyMessageResult" class="result-message" style="display:none;"></div>
            
            <div style="margin-top:20px; padding-top:20px; border-top:1px solid #333;">
                <h4>Message furtif actif</h4>
                <div id="activeSneakyMessageStatus" style="color:#888;">Chargement...</div>
                <div id="activeSneakyMessagePreview" style="background:#222; padding:10px; border-radius:8px; margin-top:10px; display:none; font-style:italic;"></div>
                <button onclick="disableSneakyMessage()" class="danger" style="margin-top:15px;">üóëÔ∏è D√©sactiver le message</button>
            </div>
        </div>
        
        <!-- Section Messages Dynamiques -->
        <div class="section">
            <h3>üí¨ Messages d'accueil dynamiques</h3>
            <p style="color:#888; font-size:14px;">Configurez les messages affich√©s selon le jour et le cr√©neau horaire.</p>
            
            <!-- Sous-onglets par jour -->
            <div class="day-tabs">
                <button class="day-tab active" data-day="lundi">Lun</button>
                <button class="day-tab" data-day="mardi">Mar</button>
                <button class="day-tab" data-day="mercredi">Mer</button>
                <button class="day-tab" data-day="jeudi">Jeu</button>
                <button class="day-tab" data-day="vendredi">Ven</button>
            </div>
            
            <form id="welcomeMessagesForm">
                <div id="messagesContainer"></div>
                <button type="submit">üíæ Enregistrer les messages</button>
            </form>
            <div id="messagesResult" class="result-message" style="display:none;"></div>
        </div>
    </div>

    <!-- ==================== ONGLET COULEURS ==================== -->
    <div class="tab-content" id="tab-colors">
        <div class="section">
            <h3>üè∑Ô∏è R√®gles de couleurs</h3>
            <p style="color:#888; font-size:14px;">D√©finissez les couleurs d'affichage des √©v√©nements selon les mots-cl√©s.</p>
            
            <div id="colorRulesContainer"></div>
            
            <button class="secondary" onclick="addColorRule()">‚ûï Ajouter une r√®gle</button>
            <button onclick="saveColorRules()">üíæ Enregistrer les r√®gles</button>
            <div id="colorRulesResult" class="result-message" style="display:none;"></div>
        </div>
    </div>

    <!-- ==================== ONGLET IC√îNES ==================== -->
    <div class="tab-content" id="tab-icons">
        <!-- Section Import GIF -->
        <div class="section">
            <h3>üì• Importer des ic√¥nes</h3>
            <p style="color:#888; font-size:14px;">Uploadez de nouvelles ic√¥nes (GIF anim√©s ou PNG avec transparence).</p>
            
            <form id="gifUploadForm">
                <div class="form-group">
                    <label>S√©lectionner un fichier GIF ou PNG</label>
                    <input type="file" id="gifInput" accept="image/gif,image/png">
                </div>
                <button type="submit">üì§ Importer le GIF</button>
            </form>
            <div id="gifUploadResult" class="result-message" style="display:none;"></div>
        </div>
        
        <!-- Section Galerie GIF -->
        <div class="section">
            <h3>üñºÔ∏è Galerie des ic√¥nes disponibles</h3>
            <p style="color:#888; font-size:14px;">Cliquez sur une ic√¥ne pour la supprimer.</p>
            <div id="gifsGallery" class="gifs-gallery"></div>
        </div>
        
        <!-- Section Association Lieu -> Ic√¥ne -->
        <div class="section">
            <h3>üé¨ Associer des ic√¥nes aux lieux</h3>
            <p style="color:#888; font-size:14px;">D√©finissez quelle ic√¥ne afficher √† gauche d'un √©v√©nement selon son lieu.</p>
            
            <div id="locationIconRulesContainer"></div>
            
            <button class="secondary" onclick="addLocationIconRule()">‚ûï Ajouter une r√®gle</button>
            <button onclick="saveLocationIconRules()">üíæ Enregistrer les r√®gles</button>
            <div id="locationIconRulesResult" class="result-message" style="display:none;"></div>
        </div>
    </div>

    <!-- ==================== ONGLET LOGO ==================== -->
    <div class="tab-content" id="tab-logo">
        <div class="section">
            <h3>üñºÔ∏è Logo de l'entreprise</h3>
            <form id="logoForm">
                <div class="form-group">
                    <label>S√©lectionner une image</label>
                    <input type="file" id="logoInput" accept="image/*">
                </div>
                <button type="submit">üì§ Uploader le logo</button>
            </form>
            <div id="logoResult" class="result-message" style="display:none;"></div>
            <p style="margin-top:20px; color:#888;">Logo actuel :</p>
            <img id="logoPreview" class="logo-preview" src="/api/logo" alt="Logo actuel">
        </div>
    </div>

    <!-- ==================== ONGLET PHOTO FURTIVE ==================== -->
    <div class="tab-content" id="tab-photo">
        <div class="section">
            <h3>üì∏ Photo furtive</h3>
            <p style="color:#888; font-size:14px;">Uploadez une photo qui d√©filera en bas de l'√©cran pendant la dur√©e choisie.</p>
            
            <form id="sneakyPhotoForm">
                <div class="form-group">
                    <label>S√©lectionner une photo</label>
                    <input type="file" id="sneakyPhotoInput" accept="image/*">
                </div>
                <div class="form-group">
                    <label>Dur√©e d'affichage</label>
                    <select id="sneakyPhotoDuration">
                        <option value="15">15 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="60">1 heure</option>
                        <option value="240">4 heures</option>
                        <option value="endOfDay">Jusqu'√† la fin de la journ√©e</option>
                        <option value="endOfWeek">Jusqu'√† la fin de la semaine</option>
                    </select>
                </div>
                <button type="submit">üì§ Activer la photo furtive</button>
            </form>
            <div id="photoResult" class="result-message" style="display:none;"></div>
            
            <div style="margin-top:20px; padding-top:20px; border-top:1px solid #333;">
                <h4>Photo furtive active</h4>
                <div id="activePhotoStatus" style="color:#888;">Chargement...</div>
                <img id="sneakyPhotoPreview" style="max-width:200px; max-height:150px; margin-top:10px; border-radius:8px; display:none;">
                <button onclick="disableSneakyPhoto()" class="danger" style="margin-top:15px;">üóëÔ∏è D√©sactiver la photo</button>
            </div>
        </div>
    </div>

    <!-- ==================== ONGLET SYNC ==================== -->
    <div class="tab-content" id="tab-sync">
        <div class="section">
            <h3>üîÑ Synchronisation</h3>
            <p style="color:#888; font-size:14px;">Forcez une synchronisation imm√©diate du calendrier Google.</p>
            <button onclick="forceSync()">üîÑ Synchroniser maintenant</button>
            <div id="syncResult" class="result-message" style="display:none;"></div>
        </div>
    </div>

    <!-- ==================== OVERLAY MOSA√èQUE IC√îNES ==================== -->
    <div id="iconMosaicOverlay" class="icon-mosaic-overlay">
        <div class="icon-mosaic-container">
            <h3>üé¨ Choisir une ic√¥ne</h3>
            <div id="iconMosaic" class="icon-mosaic"></div>
            <button class="secondary icon-mosaic-close" onclick="closeIconMosaic()">‚ùå Annuler</button>
        </div>
    </div>

    <script>
      const backendUrl = location.origin;
      const days = ["lundi", "mardi", "mercredi", "jeudi", "vendredi"];
      const slots = [
        { id: "matin", label: "Matin (06h-09h30)" },
        { id: "matinee", label: "Matin√©e (09h30-12h)" },
        { id: "midi", label: "Midi (12h-13h)" },
        { id: "apres_midi", label: "Apr√®s-midi (13h-18h)" },
        { id: "soir", label: "Soir (18h-06h)" }
      ];
      let colorRulesData = [];
      let welcomeMessagesData = {};

      // ========== NAVIGATION ONGLETS ==========
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
      });

      // ========== NAVIGATION JOURS ==========
      document.querySelectorAll('.day-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.day-tab').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.day-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('day-' + btn.dataset.day).classList.add('active');
        });
      });

      // ========== CONFIGURATION ==========
      async function loadConfig() {
        const res = await fetch(`${backendUrl}/api/config`);
        const config = await res.json();
        document.getElementById('primaryColor').value = config.primaryColor || '#00e1ff';
        document.getElementById('secondaryColor').value = config.secondaryColor || '#000000';
        document.getElementById('fontFamily').value = config.fontFamily || 'Arial, sans-serif';
        document.getElementById('eventBgColor').value = config.eventBgColor || '#000000';
        document.getElementById('eventTextColor').value = config.eventTextColor || '#ffffff';
        document.getElementById('showWeatherToggle').checked = config.showWeather || false;
      }

      document.getElementById('configForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
          primaryColor: document.getElementById('primaryColor').value,
          secondaryColor: document.getElementById('secondaryColor').value,
          fontFamily: document.getElementById('fontFamily').value,
          eventBgColor: document.getElementById('eventBgColor').value,
          eventTextColor: document.getElementById('eventTextColor').value,
          showWeather: document.getElementById('showWeatherToggle').checked
        };
        await fetch(`${backendUrl}/api/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        showResult('configResult', 'Configuration enregistr√©e !', true);
      });

      // ========== MESSAGES DYNAMIQUES ==========
      async function loadWelcomeMessages() {
        const res = await fetch(`${backendUrl}/api/welcome-messages`);
        const data = await res.json();
        welcomeMessagesData = data.welcomeMessages || {};
        renderMessagesForm();
      }

      function renderMessagesForm() {
        const container = document.getElementById('messagesContainer');
        container.innerHTML = '';
        
        days.forEach(day => {
          const dayDiv = document.createElement('div');
          dayDiv.className = 'day-content' + (day === 'lundi' ? ' active' : '');
          dayDiv.id = 'day-' + day;
          
          let html = '';
          slots.forEach(slot => {
            const val = welcomeMessagesData?.[day]?.[slot.id] || '';
            html += `
              <div class="form-group">
                <label>${slot.label}</label>
                <textarea id="${day}_${slot.id}" placeholder="Message pour ${slot.label.toLowerCase()}...">${val}</textarea>
              </div>
            `;
          });
          dayDiv.innerHTML = html;
          container.appendChild(dayDiv);
        });
      }

      document.getElementById('welcomeMessagesForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const messages = {};
        days.forEach(day => {
          messages[day] = {};
          slots.forEach(slot => {
            messages[day][slot.id] = document.getElementById(`${day}_${slot.id}`).value;
          });
        });
        
        const res = await fetch(`${backendUrl}/api/welcome-messages`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ welcomeMessages: messages })
        });
        showResult('messagesResult', res.ok ? 'Messages enregistr√©s !' : 'Erreur', res.ok);
      });

      // ========== R√àGLES COULEURS ==========
      async function loadColorRules() {
        try {
          const res = await fetch(`${backendUrl}/api/event-color-rules`);
          const data = await res.json();
          colorRulesData = data.rules || [];
        } catch (err) {
          colorRulesData = [];
        }
        renderColorRules();
      }

      function renderColorRules() {
        const container = document.getElementById('colorRulesContainer');
        container.innerHTML = '';
        
        colorRulesData.forEach((rule, index) => {
          container.innerHTML += `
            <div class="color-rule">
              <div class="color-rule-row">
                <input type="text" placeholder="Mot-cl√©" value="${rule.keyword || ''}" 
                       onchange="colorRulesData[${index}].keyword = this.value">
                <input type="color" value="${rule.color || '#ffffff'}" 
                       onchange="colorRulesData[${index}].color = this.value">
                <button class="danger" onclick="removeRule(${index})" style="width:auto;">üóëÔ∏è</button>
              </div>
              <input type="text" placeholder="Description (optionnel)" value="${rule.description || ''}" 
                     onchange="colorRulesData[${index}].description = this.value" style="margin-top:10px;">
            </div>
          `;
        });
      }

      function addColorRule() {
        colorRulesData.push({ keyword: '', color: '#00e1ff', description: '' });
        renderColorRules();
      }

      function removeRule(index) {
        colorRulesData.splice(index, 1);
        renderColorRules();
      }

      async function saveColorRules() {
        const res = await fetch(`${backendUrl}/api/event-color-rules`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rules: colorRulesData })
        });
        showResult('colorRulesResult', res.ok ? 'R√®gles enregistr√©es !' : 'Erreur', res.ok);
      }

      // ========== GESTION DES IC√îNES DE LIEUX ==========
      let availableGifs = [];
      let locationIconRules = [];
      let currentIconRuleIndex = null;

      // Charger la liste des GIFs disponibles
      async function loadAvailableGifs() {
        try {
          const res = await fetch(`${backendUrl}/api/location-gifs`);
          const data = await res.json();
          availableGifs = data.gifs || [];
          renderGifsGallery();
          renderIconMosaic();
        } catch (err) {
          console.error('Erreur chargement GIFs:', err);
          availableGifs = [];
        }
      }

      // Afficher la galerie de GIFs
      function renderGifsGallery() {
        const gallery = document.getElementById('gifsGallery');
        if (!gallery) return;
        
        if (availableGifs.length === 0) {
          gallery.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">Aucune ic√¥ne disponible. Importez des fichiers GIF.</div>';
          return;
        }
        
        gallery.innerHTML = availableGifs.map(gif => `
          <div class="gif-item" onclick="confirmDeleteGif('${gif}')">
            <div class="delete-overlay">üóëÔ∏è</div>
            <img src="/gifs/${gif}" alt="${gif}">
            <div class="gif-name">${gif.replace('.gif', '')}</div>
          </div>
        `).join('');
      }

      // Confirmer la suppression d'un GIF
      async function confirmDeleteGif(filename) {
        if (!confirm(`Supprimer l'ic√¥ne "${filename}" ?`)) return;
        
        try {
          const res = await fetch(`${backendUrl}/api/location-gifs/${encodeURIComponent(filename)}`, {
            method: 'DELETE'
          });
          if (res.ok) {
            showResult('gifUploadResult', 'Ic√¥ne supprim√©e !', true);
            loadAvailableGifs();
          } else {
            showResult('gifUploadResult', 'Erreur lors de la suppression', false);
          }
        } catch (err) {
          showResult('gifUploadResult', 'Erreur de connexion', false);
        }
      }

      // Upload de GIF
      document.getElementById('gifUploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = document.getElementById('gifInput').files[0];
        if (!file) {
          showResult('gifUploadResult', 'Veuillez s√©lectionner un fichier GIF', false);
          return;
        }
        
        const formData = new FormData();
        formData.append('gif', file);
        
        try {
          const res = await fetch(`${backendUrl}/api/location-gifs`, {
            method: 'POST',
            body: formData
          });
          if (res.ok) {
            showResult('gifUploadResult', 'Ic√¥ne import√©e avec succ√®s !', true);
            document.getElementById('gifInput').value = '';
            loadAvailableGifs();
          } else {
            const data = await res.json();
            showResult('gifUploadResult', data.error || 'Erreur lors de l\'import', false);
          }
        } catch (err) {
          showResult('gifUploadResult', 'Erreur de connexion', false);
        }
      });

      // Charger les r√®gles d'ic√¥nes de lieux
      async function loadLocationIconRules() {
        try {
          const res = await fetch(`${backendUrl}/api/location-icons`);
          const data = await res.json();
          locationIconRules = data.rules || [];
        } catch (err) {
          locationIconRules = [];
        }
        renderLocationIconRules();
      }

      // Afficher les r√®gles d'ic√¥nes de lieux
      function renderLocationIconRules() {
        const container = document.getElementById('locationIconRulesContainer');
        if (!container) return;
        
        if (locationIconRules.length === 0) {
          container.innerHTML = '<div style="color:#888; text-align:center; padding:15px;">Aucune r√®gle d√©finie. Cliquez sur "Ajouter une r√®gle".</div>';
          return;
        }
        
        container.innerHTML = locationIconRules.map((rule, index) => `
          <div class="icon-rule">
            <div class="icon-rule-row">
              <div class="icon-selector" onclick="openIconMosaic(${index})">
                <div class="selected-icon ${rule.icon ? '' : 'empty'}">
                  ${rule.icon ? `<img src="/gifs/${rule.icon}" alt="${rule.icon}">` : '‚ûï'}
                </div>
              </div>
              <input type="text" placeholder="Mot-cl√© du lieu (ex: Salle A, Bureau...)" 
                     value="${rule.keyword || ''}" 
                     onchange="locationIconRules[${index}].keyword = this.value">
              <button class="danger" onclick="removeLocationIconRule(${index})" style="width:auto;">üóëÔ∏è</button>
            </div>
          </div>
        `).join('');
      }

      // Ajouter une r√®gle d'ic√¥ne
      function addLocationIconRule() {
        locationIconRules.push({ keyword: '', icon: '' });
        renderLocationIconRules();
      }

      // Supprimer une r√®gle d'ic√¥ne
      function removeLocationIconRule(index) {
        locationIconRules.splice(index, 1);
        renderLocationIconRules();
      }

      // Ouvrir la mosa√Øque pour s√©lectionner une ic√¥ne
      function openIconMosaic(ruleIndex) {
        currentIconRuleIndex = ruleIndex;
        renderIconMosaic();
        document.getElementById('iconMosaicOverlay').classList.add('active');
      }

      // Fermer la mosa√Øque
      function closeIconMosaic() {
        document.getElementById('iconMosaicOverlay').classList.remove('active');
        currentIconRuleIndex = null;
      }

      // Afficher la mosa√Øque des ic√¥nes
      function renderIconMosaic() {
        const mosaic = document.getElementById('iconMosaic');
        if (!mosaic) return;
        
        if (availableGifs.length === 0) {
          mosaic.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#888; padding:20px;">Aucune ic√¥ne disponible. Importez d\'abord des fichiers GIF.</div>';
          return;
        }
        
        mosaic.innerHTML = availableGifs.map(gif => `
          <div class="icon-mosaic-item" onclick="selectIcon('${gif}')">
            <img src="/gifs/${gif}" alt="${gif}">
          </div>
        `).join('');
      }

      // S√©lectionner une ic√¥ne dans la mosa√Øque
      function selectIcon(gifFilename) {
        if (currentIconRuleIndex !== null && locationIconRules[currentIconRuleIndex]) {
          locationIconRules[currentIconRuleIndex].icon = gifFilename;
          renderLocationIconRules();
        }
        closeIconMosaic();
      }

      // Sauvegarder les r√®gles d'ic√¥nes
      async function saveLocationIconRules() {
        // Filtrer les r√®gles vides
        const validRules = locationIconRules.filter(r => r.keyword && r.icon);
        
        const res = await fetch(`${backendUrl}/api/location-icons`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rules: validRules })
        });
        
        if (res.ok) {
          showResult('locationIconRulesResult', 'R√®gles d\'ic√¥nes enregistr√©es !', true);
          locationIconRules = validRules;
          renderLocationIconRules();
        } else {
          showResult('locationIconRulesResult', 'Erreur lors de l\'enregistrement', false);
        }
      }

      // ========== LOGO ==========
      document.getElementById('logoForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = document.getElementById('logoInput').files[0];
        if (!file) {
          showResult('logoResult', 'Veuillez s√©lectionner un fichier', false);
          return;
        }
        const formData = new FormData();
        formData.append('logo', file);
        const res = await fetch(`${backendUrl}/api/logo`, {
          method: 'POST',
          body: formData
        });
        if (res.ok) {
          document.getElementById('logoPreview').src = '/api/logo?' + Date.now();
          showResult('logoResult', 'Logo mis √† jour !', true);
        } else {
          showResult('logoResult', 'Erreur lors de l\'upload', false);
        }
      });

      // ========== SYNCHRONISATION ==========
      async function forceSync() {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '‚è≥ Synchronisation...';
        
        try {
          const res = await fetch(`${backendUrl}/api/sync`, { method: 'POST' });
          const data = await res.json();
          showResult('syncResult', res.ok ? 'Synchronisation r√©ussie !' : 'Erreur: ' + data.error, res.ok);
        } catch (err) {
          showResult('syncResult', 'Erreur de connexion', false);
        }
        
        btn.disabled = false;
        btn.textContent = 'üîÑ Synchroniser maintenant';
      }

      // ========== GESTION DES √âV√âNEMENTS ==========
      let adminCompletedEvents = [];
      
      async function loadAdminEvents() {
        try {
          // Charger les √©v√©nements
          const eventsRes = await fetch(`${backendUrl}/api/events`);
          const eventsData = await eventsRes.json();
          
          // Charger les √©v√©nements termin√©s
          const completedRes = await fetch(`${backendUrl}/api/completed-events`);
          const completedData = await completedRes.json();
          adminCompletedEvents = completedData.completed || [];
          
          // Afficher les √©v√©nements r√©guliers
          const regularContainer = document.getElementById('adminRegularEvents');
          const regularEvents = eventsData.regular || [];
          
          if (regularEvents.length === 0) {
            regularContainer.innerHTML = '<div class="no-events">Aucun √©v√©nement ponctuel aujourd\'hui</div>';
          } else {
            regularContainer.innerHTML = regularEvents.map(e => renderAdminEvent(e)).join('');
          }
          
          // Afficher les √©v√©nements r√©currents
          const recurrentContainer = document.getElementById('adminRecurrentEvents');
          const recurrentEvents = eventsData.recurrent || [];
          
          if (recurrentEvents.length === 0) {
            recurrentContainer.innerHTML = '<div class="no-events">Aucun √©v√©nement r√©current aujourd\'hui</div>';
          } else {
            recurrentContainer.innerHTML = recurrentEvents.map(e => renderAdminEvent(e)).join('');
          }
          
        } catch (err) {
          console.error('Erreur chargement √©v√©nements:', err);
          showResult('eventsResult', 'Erreur de chargement', false);
        }
      }
      
      function renderAdminEvent(event) {
        const eventId = String(event.uid || `${event.title || event.summary}_${event.start}`);
        const isCompleted = adminCompletedEvents.includes(eventId);
        const startTime = new Date(event.start);
        const timeStr = startTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        const title = event.title || event.summary || 'Sans titre';
        const location = event.location || '';
        
        return `
          <div class="admin-event ${isCompleted ? 'completed' : ''}" 
               onclick="toggleAdminEvent('${eventId}', this)"
               data-event-id="${eventId}">
            <span class="check">${isCompleted ? '‚úÖ' : '‚¨ú'}</span>
            <span class="time">${timeStr}</span>
            <span class="title">${title}</span>
            ${location ? `<span class="location">üìç ${location}</span>` : ''}
          </div>
        `;
      }
      
      async function toggleAdminEvent(eventId, element) {
        const strEventId = String(eventId);
        const isCompleted = adminCompletedEvents.includes(strEventId);
        const endpoint = isCompleted ? '/api/uncomplete-event' : '/api/complete-event';
        
        try {
          const res = await fetch(`${backendUrl}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ eventId: strEventId })
          });
          
          if (res.ok) {
            if (isCompleted) {
              adminCompletedEvents = adminCompletedEvents.filter(id => id !== strEventId);
              element.classList.remove('completed');
              element.querySelector('.check').textContent = '‚¨ú';
            } else {
              adminCompletedEvents.push(strEventId);
              element.classList.add('completed');
              element.querySelector('.check').textContent = '‚úÖ';
            }
            showResult('eventsResult', isCompleted ? '√âv√©nement r√©activ√©' : '√âv√©nement termin√© !', true);
          }
        } catch (err) {
          showResult('eventsResult', 'Erreur lors de la mise √† jour', false);
        }
      }

      // ========== UTILITAIRES ==========
      function showResult(elementId, message, success) {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.className = 'result-message ' + (success ? 'success' : 'error');
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 3000);
      }

      // ========== PHOTO FURTIVE ==========
      document.getElementById('sneakyPhotoForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = document.getElementById('sneakyPhotoInput').files[0];
        if (!file) {
          showResult('photoResult', 'Veuillez s√©lectionner une photo', false);
          return;
        }
        
        const duration = document.getElementById('sneakyPhotoDuration').value;
        const formData = new FormData();
        formData.append('photo', file);
        formData.append('duration', duration);
        
        try {
          const res = await fetch(`${backendUrl}/api/sneaky-photo`, {
            method: 'POST',
            body: formData
          });
          if (res.ok) {
            showResult('photoResult', 'Photo furtive activ√©e !', true);
            loadSneakyPhotoStatus();
          } else {
            showResult('photoResult', 'Erreur lors de l\'upload', false);
          }
        } catch (err) {
          showResult('photoResult', 'Erreur de connexion', false);
        }
      });
      
      async function loadSneakyPhotoStatus() {
        try {
          const res = await fetch(`${backendUrl}/api/sneaky-photo/status`);
          const data = await res.json();
          const statusEl = document.getElementById('activePhotoStatus');
          const previewEl = document.getElementById('sneakyPhotoPreview');
          
          if (data.active) {
            const expireDate = new Date(data.expiresAt);
            statusEl.innerHTML = `<span style="color:#00ff00;">‚úÖ Active</span> - Expire: ${expireDate.toLocaleString('fr-FR')}`;
            previewEl.src = `${backendUrl}/api/sneaky-photo/image?t=${Date.now()}`;
            previewEl.style.display = 'block';
          } else {
            statusEl.innerHTML = '<span style="color:#888;">‚ùå Aucune photo active</span>';
            previewEl.style.display = 'none';
          }
        } catch (err) {
          document.getElementById('activePhotoStatus').textContent = 'Erreur de chargement';
        }
      }
      
      async function disableSneakyPhoto() {
        try {
          const res = await fetch(`${backendUrl}/api/sneaky-photo`, { method: 'DELETE' });
          if (res.ok) {
            showResult('photoResult', 'Photo d√©sactiv√©e', true);
            loadSneakyPhotoStatus();
          }
        } catch (err) {
          showResult('photoResult', 'Erreur', false);
        }
      }

      // ========== MESSAGE FURTIF ==========
      document.getElementById('sneakyMessageForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = document.getElementById('sneakyMessageText').value;
        if (!message.trim()) {
          showResult('sneakyMessageResult', 'Veuillez entrer un message', false);
          return;
        }
        
        const duration = document.getElementById('sneakyMessageDuration').value;
        
        try {
          const res = await fetch(`${backendUrl}/api/sneaky-message`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message, duration })
          });
          if (res.ok) {
            showResult('sneakyMessageResult', 'Message furtif activ√© !', true);
            document.getElementById('sneakyMessageText').value = '';
            loadSneakyMessageStatus();
          } else {
            showResult('sneakyMessageResult', 'Erreur lors de l\'activation', false);
          }
        } catch (err) {
          showResult('sneakyMessageResult', 'Erreur de connexion', false);
        }
      });
      
      async function loadSneakyMessageStatus() {
        try {
          const res = await fetch(`${backendUrl}/api/sneaky-message/status`);
          const data = await res.json();
          const statusEl = document.getElementById('activeSneakyMessageStatus');
          const previewEl = document.getElementById('activeSneakyMessagePreview');
          
          if (data.active) {
            const expireDate = new Date(data.expiresAt);
            statusEl.innerHTML = `<span style="color:#00ff00;">‚úÖ Actif</span> - Expire: ${expireDate.toLocaleString('fr-FR')}`;
            previewEl.textContent = `"${data.message}"`;
            previewEl.style.display = 'block';
          } else {
            statusEl.innerHTML = '<span style="color:#888;">‚ùå Aucun message actif</span>';
            previewEl.style.display = 'none';
          }
        } catch (err) {
          document.getElementById('activeSneakyMessageStatus').textContent = 'Erreur de chargement';
        }
      }
      
      async function disableSneakyMessage() {
        try {
          const res = await fetch(`${backendUrl}/api/sneaky-message`, { method: 'DELETE' });
          if (res.ok) {
            showResult('sneakyMessageResult', 'Message d√©sactiv√©', true);
            loadSneakyMessageStatus();
          }
        } catch (err) {
          showResult('sneakyMessageResult', 'Erreur', false);
        }
      }

      // ========== INITIALISATION ==========
      document.addEventListener('DOMContentLoaded', () => {
        loadAdminEvents(); // Charger les √©v√©nements au d√©marrage
        loadConfig();
        loadWelcomeMessages();
        loadColorRules();
        loadAvailableGifs(); // Charger les GIFs disponibles
        loadLocationIconRules(); // Charger les r√®gles d'ic√¥nes
        loadSneakyPhotoStatus();
        loadSneakyMessageStatus();
        
        // Scroll toggle
        const scrollToggle = document.getElementById('scrollToggle');
        scrollToggle.checked = localStorage.getItem('scrollEnabled') !== 'false';
        scrollToggle.addEventListener('change', () => {
          localStorage.setItem('scrollEnabled', scrollToggle.checked);
        });
      });
    </script>
</body>
</html>